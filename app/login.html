<!DOCTYPE html>
<!--
APP：车护宝微配配件商WEB version 1.0.0
Author：sofichael@126.com
SITE：http://pjs.weipei.com
-->
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
  <meta charset="utf-8" />
  <title>登录-车护宝微配后台管理</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta name="keywords" content="车护宝－微配，汽车配价商专业平台" />
  <meta name="description" content="车护宝－微配提供标准的服务、诚心甄选配件商服务店、旨在为千万维修厂提供优质省心的汽车配价询价服务">
  <meta content="author" name="sofichael@126.com"/>
  <!-- BEGIN GLOBAL MANDATORY STYLES -->
  <link href="media/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/style-metro.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/style.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/style-responsive.css" rel="stylesheet" type="text/css"/>
  <link href="media/css/default.css" rel="stylesheet" type="text/css" id="style_color"/>
  <link href="media/css/uniform.default.css" rel="stylesheet" type="text/css"/>
  <!-- END GLOBAL MANDATORY STYLES -->
  <!-- BEGIN PAGE LEVEL STYLES -->
  <link href="media/css/login.css" rel="stylesheet" type="text/css"/>
  <!-- END PAGE LEVEL STYLES -->
  <link rel="icon" type="image/ico" href="images/favicon.ico"/>
</head>
<!-- END HEAD -->
<!-- BEGIN BODY -->
<body class="login hidden">
  <!-- BEGIN LOGO -->
  <div class="logo">
    <img src="images/logo-weipei.png" alt=""/>
  </div>
  <!-- END LOGO -->
  <!-- BEGIN LOGIN -->
  <div class="content">
    <!-- BEGIN LOGIN FORM -->
    <form class="form-vertical login-form">
      <h3 class="form-title">登录</h3>
      <div class="control-group" id="loginAccount">
        <!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
        <label class="control-label visible-ie8 visible-ie9">手机号</label>
        <div class="controls">
          <div class="input-icon left">
            <i class="icon-user"></i>
            <input class="m-wrap placeholder-no-fix" type="text" placeholder="手机号" name="account"/>
          </div>
        </div>
      </div>
      <div class="control-group" id="loginPassword">
        <label class="control-label visible-ie8 visible-ie9">密码</label>
        <div class="controls">
          <div class="input-icon left input-append">
            <i class="icon-lock"></i>
            <input class="m-wrap placeholder-no-fix" type="password" placeholder="密码" name="password"/>
            <span class="add-on"><i class="icon-eye-close"></i></span>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <label class="checkbox">
        <input type="checkbox" name="remember" value="1"/> 记住密码
        </label>
        <button id="login-submit" type="button" class="btn btn-block yellow pull-right">
        登录<img src="images/ajax-loading.gif" alt="" class="ajax-loding hidden">
        </button>
      </div>
      <p id="login-msg" class="hidden" style="color:#b94a48"></p>
      <div class="forget-password">
        <p>
          <a href="javascript:;" id="forget-password" class="">忘记密码 ?&nbsp;</a>
          <a href="javascript:;" id="register-btn" class="pull-right">没有账号 ?&nbsp;</a>
        </p>
      </div>
    </form>
    <!-- END LOGIN FORM -->
    <!-- BEGIN FORGOT PASSWORD FORM -->
    <form class="form-vertical forget-form">
      <h3 class="">忘记密码 ?</h3>
      <p>输入你手机号重置你的密码.</p>
      <div class="control-group" id="forgetMobile">
        <label class="control-label visible-ie8 visible-ie9">手机号</label>
        <div class="controls">
          <div class="input-icon left input-append">
            <i class="icon-user"></i>
            <input class="m-wrap send-code placeholder-no-fix" type="text" placeholder="手机号" name="mobile">
            <div class="btn-group" id="sendMobileForgetCode">
              <button type="button" class="btn yellow">发送验证码</button>
            </div>
          </div>
        </div>
      </div>
      <div class="control-group" id="mobileForgetCode">
        <label class="control-label visible-ie8 visible-ie9">输入收到的验证码</label>
        <div class="controls">
          <div class="input-icon left">
            <i class=" icon-envelope-alt"></i>
            <input class="m-wrap placeholder-no-fix" type="text" placeholder="输入收到的验证码" name="mobileCode"/>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" id="back-btn" class="btn">
        <i class="m-icon-swapleft"></i> 返回登录
        </button>
        <button type="button" class="btn yellow pull-right" id="reset-form-next">
        下一步 <i class="m-icon-swapright m-icon-white"></i>
        </button>
      </div>
    </form>
    <form class="form-vertical reset-form">
      <h3 class="">重置密码</h3>
      <div class="control-group" id="resetNewPassword">
        <label class="control-label visible-ie8 visible-ie9">新密码</label>
        <div class="controls">
          <div class="input-icon left input-append">
            <i class="icon-lock"></i>
            <input class="m-wrap placeholder-no-fix" type="password" placeholder="新密码" name="password"/>
            <span class="add-on"><i class="icon-eye-close"></i></span>
          </div>
        </div>
      </div>
      <div class="control-group" id="resetRePassword">
        <label class="control-label visible-ie8 visible-ie9">确认新密码</label>
        <div class="controls">
          <div class="input-icon left input-append">
            <i class="icon-lock"></i>
            <input class="m-wrap placeholder-no-fix" type="password" id="reset_password" placeholder="确认新密码" name="rpassword"/>
            <span class="add-on"><i class="icon-eye-close"></i></span>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" id="reset-back-btn" class="btn">
        <i class="m-icon-swapleft"></i> 上一步
        </button>
        <button type="button" class="btn yellow pull-right" id="reset-password">
        确认 <i class="m-icon-swapright m-icon-white"></i>
        </button>
      </div>
      <p id="reset-msg" class="hidden" style="color:#b94a48"></p>
    </form>
    <!-- END FORGOT PASSWORD FORM -->
    <!-- BEGIN REGISTRATION FORM -->
    <form class="form-vertical register-form">
      <h3 class="">注册</h3>
      <p>填写个人注册信息:</p>
      <div class="control-group" id="mobileDiv">
        <label class="control-label visible-ie8 visible-ie9">手机号</label>
        <div class="controls">
          <div class="input-icon left input-append">
            <i class="icon-user"></i>
            <input class="m-wrap send-code placeholder-no-fix" type="text" placeholder="手机号" name="mobile">
            <div class="btn-group" id="sendMobileCode">
              <button type="button" class="btn yellow">发送验证码</button>
            </div>
          </div>
        </div>
      </div>
      <div class="control-group" id="mobileCode">
        <label class="control-label visible-ie8 visible-ie9">输入收到的验证码</label>
        <div class="controls">
          <div class="input-icon left">
            <i class=" icon-envelope-alt"></i>
            <input class="m-wrap placeholder-no-fix" type="text" placeholder="输入收到的验证码" name="mobileCode"/>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label visible-ie8 visible-ie9">输入密码</label>
        <div class="controls">
          <div class="input-icon left">
            <i class=" icon-envelope-alt"></i>
            <input class="m-wrap placeholder-no-fix" id="register_password" type="password" placeholder="密码" name="password"/>
          </div>
        </div>
      </div>
      <div class="control-group" id="">
        <label class="control-label visible-ie8 visible-ie9">再次输入密码</label>
        <div class="controls">
          <div class="input-icon left">
            <i class=" icon-envelope-alt"></i>
            <input class="m-wrap placeholder-no-fix" type="password" placeholder="再次输入密码" name="rpassword"/>
          </div>
        </div>
      </div>
      <div class="form-actions" style="padding-bottom:10px;">
        <button id="register-back-btn" type="button" class="btn">
        <i class="m-icon-swapleft"></i>  返回登录
        </button>
        <button type="button" id="register-submit" class="btn yellow pull-right">
        注册 <i class="m-icon-swapright m-icon-white"></i>
        </button>
      </div>
      <p id="register-msg" class="hidden" style="color:#b94a48"></p>
    </form>
    <!-- END REGISTRATION FORM -->
  </div>
  <!-- END LOGIN -->
  <!-- BEGIN COPYRIGHT -->
  <div class="copyright">
    2015 &copy; 微配.
  </div>
  <div class="backstretch" style="left: 0px; top: 0px; overflow: hidden; margin: 0px; padding: 0px; height: 100%; width: 100%; z-index: -999999; position: fixed;">
  <img style="position: absolute; margin: 0px; padding: 0px; border: none; width: 100%; height: 100%; max-width: none; z-index: -999999; left: 0px;" src="media/image/bg/1.jpg">
  </div>
  <!-- END COPYRIGHT -->
  <!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->
  <!-- BEGIN CORE PLUGINS -->
  <script src="media/js/jquery-1.10.1.min.js" type="text/javascript"></script>
  <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-ajaxtransport-xdomainrequest/1.0.3/jquery.xdomainrequest.min.js" type="text/javascript"></script> -->
  <script src="bower_components/cros.js?" type="text/javascript"></script>
  <script src="media/js/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
  <!-- IMPORTANT! Load jquery-ui-1.10.1.custom.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip -->
  <script src="media/js/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>
  <script src="media/js/bootstrap.min.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
  <script src="media/js/excanvas.min.js" type="text/javascript"></script>
  <script src="media/js/respond.min.js" type="text/javascript"></script>
  <![endif]-->
  <!-- <script src="media/js/jquery.slimscroll.min.js" type="text/javascript"></script> -->
  <script src="media/js/jquery.blockui.min.js" type="text/javascript"></script>
  <script src="media/js/jquery.cookie.min.js" type="text/javascript"></script>
  <script src="media/js/jquery.uniform.min.js" type="text/javascript" ></script>
  <!-- END CORE PLUGINS -->
  <!-- BEGIN PAGE LEVEL PLUGINS -->
  <script src="media/js/jquery.validate.min.js" type="text/javascript"></script>
  <script src="bower_components/blueimp-md5/js/md5.min.js" type="text/javascript"></script>
  <!-- END PAGE LEVEL PLUGINS -->
  <!-- BEGIN PAGE LEVEL SCRIPTS -->
  <script src="media/js/app.js?rev=1.0.0" type="text/javascript"></script>
  <script src="media/js/login.js?rev=1.0.0" type="text/javascript"></script>
  <!-- END PAGE LEVEL SCRIPTS -->
  <script>
    if (window.location.host.match(/pjs\.weipei\.cc/)){
        BASE_URL = 'http://api.weipei.cc/v1/';
    } else{
        BASE_URL = 'http://api.dev.weipei.cc/dev/v1/';
    }

  function setCookie (key,val) {
    'use strict';
    jQuery.cookie('WP.' + key,val,{expires: 30, path: '/'});
  }
  function getCookie (key) {
    'use strict';
    return jQuery.cookie('WP.' + key);
  }

  //判断accessToken是否过期
  if (getCookie('accessTokenExpireTime') * 1000 < new Date().getTime()) {
    window.location.href = '/';
    // console.log(getCookie('accessTokenExpireTime') * 1000);
    // console.log(new Date().getTime());
    // console.log('判断accessToken是否过期');
  }else{
    $('body').removeClass('hidden');
  }

  $(function(){
    'use strict';
    App.init();
    Login.init();

    if (App.ie8 || App.ie9) {
      alert('请使用IE10以上浏览器或者其他浏览器使用本系统');
    }

    //获取token
    function getAccessToken () {
      $.ajax({
        url: BASE_URL+'token',
        type: 'POST',
        dataType: 'json',
        data:'{"code": "WeiPeiWebClient","api_key": "0b1378ed6a2872620292990baea972a2"}'
      })
      .done(function(result) {
        if (result.status === 1) {
          //setCookie('tokenExpireTime',result.exipiry_time);
          setCookie('token',result.token);
        }
      })
      .fail(function() {
        console.log('getAccessToken error');
      });
    }

    //token为空重新取token
    if (getCookie('token') === undefined) {
        console.log('getgetAccessToken');
        getAccessToken();
    }

    var validateSendCode = false;
    //发送手机验证码
    function sendMobileCode (mobile) {
      $.ajax({
        url: BASE_URL+'mobile_verification_code',
        type: 'POST',
        dataType: 'json',
        headers: {Authorization: getCookie('token')},
        data: '{"mobile": "'+mobile+'"}'
      })
      .done(function(result) {
        if (result.status === 1) {
          setCookie('verificationCode',result.verification_code);
          if (!$('#mobileDiv').find('label').hasClass('help-inline')) {
              $('#mobileDiv').append('<label for="mobile" class="help-inline help-small no-left-padding" style="color: #32AE38;">验证码已发送!</label>');
          }
          $('#sendMobileCode button')[0].disabled = true;
        }else{
          if (!$('#mobileDiv').find('label').hasClass('help-inline')) {
              $('#mobileDiv').append('<label for="mobile" class="help-inline help-small no-left-padding" style="color: #32AE38;">'+result.error_msg+'</label>');
          }
        }
      })
      .fail(function() {
        console.log('发送手机验证码 error');
      });
    }

    //验证手机号格式是否正确 再发送验证码到手机
    $('#sendMobileCode').click(function() {
        var mobile = $('.register-form input[name="mobile"]').val();
        if(/^[0-9]+$/.test(mobile) && mobile.length === 11){
          sendMobileCode(mobile);
        } else {
          $(this).closest('.control-group').addClass('error');
          if (!$(this).closest('#mobileDiv').find('label').hasClass('help-inline')) {
              $('#mobileDiv').append('<label for="mobile" class="help-inline help-small no-left-padding">手机号必填!</label>');
          }
        }
    });

    //通过手机验证码注册
    function register () {
        var mobile = $('.register-form input[name="mobile"]').val();
        var mobileCode = $('.register-form input[name="mobileCode"]').val();
        var password = $('.register-form input[name="password"]').val();
        $.ajax({
          url: BASE_URL+'account',
          type: 'POST',
          dataType: 'json',
          crossDomain: true,
          headers: {Authorization: getCookie('token')},
          data: { mobile : mobile,
                    verification_code : mobileCode,
                    password : password,
                    realname : mobile,
                    avatar : ''
          }
        })
        .done(function(result) {
          if (result.status === 1) {
            $('#register-msg').removeClass('hidden');
            $('#register-msg').text('注册成功，正跳转登录...');
            setTimeout(function() {
                window.location.href = '/login.html';
            }, 2000);
          }else{
            $('#register-msg').removeClass('hidden');
            $('#register-msg').text(result.error_msg);
          }
        })
      .fail(function() {
        console.log('account error');
      });
    }

    //注册按钮
    $('#register-submit').click(function () {
            'use strict';
            if ($('.register-form').validate().form()) {
                register();
            }
    });

    $('.register-form input').keypress(function (e) {
          'use strict';
          if (e.which === 13) {
              if ($('.register-form').validate().form()) {
                  register();
              }
              return false;
          }
    });
    //注册按钮 end

    /**
     *  1. APP调用24.检查用户是否存在
     *  2. 调用2.发送手机验证码
     *  2. 如果验证通过，调用7.找回密码
     *  3. 完成密码重置
    */
    function checkUser (mobile) {
      $.ajax({
        url: BASE_URL+'user',
        type: 'PUT',
        headers: {Authorization: getCookie('token')},
        dataType: 'json',
        data:'{"account": "'+mobile+'"}'
      })
      .done(function(result) {
        if (result.status ===  1) {
            //用户验证通过 发送验证码
            sendMobileCode(mobile);
            if (!$('#forgetMobile').find('label').hasClass('help-inline')) {
                $('#forgetMobile').append('<label for="mobile" class="help-inline help-small no-left-padding" style="color: #32AE38;">验证码已发送!</label>');
            }
        } else{
          $('#forgetMobile').addClass('error');
          if (!$(this).closest('#forgetMobile').find('label').hasClass('help-inline')) {
              $('#forgetMobile').append('<label for="mobile" class="help-inline help-small no-left-padding">'+result.error_msg+'，验证码发送失败</label>');
          }
        }
      })
      .fail(function() {
        console.log('checkUser error');
      });
    }
    var validateUser = false;
    $('#sendMobileForgetCode').click(function() {
        var mobile = $('.forget-form input[name="mobile"]').val();
        if(/^[0-9]+$/.test(mobile) && mobile.length === 11){
          checkUser(mobile);
        } else {
          $(this).closest('.control-group').addClass('error');
          if (!$(this).closest('#forgetMobile').find('label').hasClass('help-inline')) {
              $('#forgetMobile').append('<label for="mobile" class="help-inline help-small no-left-padding">手机号必填!</label>');
          }
        }
    });


    //忘记密码 重置密码
    $('#reset-password').click(function() {
        if ($('.reset-form').validate().form()) {
            var mobile = $('.forget-form input[name="mobile"]').val();
            var mobileCode = $('.forget-form input[name="mobileCode"]').val();
            var password = $('.reset-form input[name="password"]').val();
            resetPassword(mobile,mobileCode,password);
        }
    });

    function resetPassword (mobile,mobileCode,password) {
      $.ajax({
        url: BASE_URL+'password ',
        type: 'PUT',
        headers: {Authorization: getCookie('token')},
        dataType: 'json',
        data:'{"mobile": "'+mobile+'","verification_code": "'+mobileCode+'","password": "'+password+'"}'
      })
      .done(function(result) {
        if (result.status ===  1) {
            $('#reset-msg').removeClass('hidden');
            $('#reset-msg').css('color', '#32AE38');
            if (result.error_msg === '') {
                $('#reset-msg').text('重置密码成功，正跳转登录...');
                setTimeout(function() {
                  window.location.href = 'login.html';
                }, 2000);
            }else{
                $('#reset-msg').text(result.error_msg);
            }
            $('#reset-msg').css('display', 'block');
        } else{
            $('#reset-msg').removeClass('hidden');
            $('#reset-msg').text(result.error_msg);
            $('#reset-msg').css('display', 'block');
        }
      })
      .fail(function() {
        console.log('resetPassword error');
      });
    }
  });


  // 登录
  function login () {
    'use strict';
    $('.ajax-loding').removeClass('hidden');
    var account = $('.login-form input[name="account"]').val();
    var password = $('.login-form input[name="password"]').val();
    jQuery.support.cors = true;
    $.ajax({
      url: BASE_URL+'login',
      type: 'POST',
      headers: {Authorization: getCookie('token')},
      dataType: 'json',
      data:'{"account": "'+account+'","password": "'+password+'"}'
    })
    .done(function(result) {
      // if (result.status ===  1 && result.account_extra.account_role === 1) {
      if (result.status ===  1) {
        if ($('input[name="remember"]').parent().hasClass('checked')) {
          setCookie('remember',true);
        }
        setCookie('accessToken',result.access_token);
        setCookie('accessTokenExpireTime',result.expiry_time);
        setCookie('account',JSON.stringify(result));
        setCookie('password',md5(password));
        setCookie('lock',false);
        if (result.account_extra !== undefined) {
          setCookie('accountExtra',JSON.stringify(result.account_extra));
        }
        window.location.href = '/';
      // } else if(result.account_extra.account_role !== 1){
      } else if(true){
        $('#login-msg').removeClass('hidden');
        $('.ajax-loding').addClass('hidden');
        // $('#login-msg').text('请使用配件商账号登录！');
        $('#login-msg').text(result.error_msg);
      }
      else{
        //清空cookie
        setCookie('accessToken',null);
        $('#login-msg').removeClass('hidden');
        $('.ajax-loding').addClass('hidden');
        $('#login-msg').text(result.error_msg || '登录失败');
      }
    })
    .fail(function(result) {
          $('#login-msg').removeClass('hidden');
          $('.ajax-loding').addClass('hidden');
          $('#login-msg').text(result.error_msg || '登录失败，请稍后重试！');
    });
  }


  // 登录按钮
  $('#login-submit').click(function () {
          'use strict';
          if ($('.login-form').validate().form()) {
              login();
          }
  });

  $('.login-form input').keypress(function (e) {
        'use strict';
        if (e.which === 13) {
            if ($('.login-form').validate().form()) {
                login();
            }
            return false;
        }
  });
  // 登录按钮 end
  </script>
  <!-- END JAVASCRIPTS -->
</body>
<!-- END BODY -->
</html>